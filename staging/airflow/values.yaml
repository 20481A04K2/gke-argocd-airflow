airflow:
  # 1. Disable internal DB/Redis
  postgresql:
    enabled: false
  redis:
    enabled: false

  # 2. Database Connection
  data:
    metadataSecretName: "airflow-db-secrets"

  # 3. Component Configs
  executor: "KubernetesExecutor"
  
  images:
    airflow:
      repository: "apache/airflow"
      tag: "2.10.0"

  # ---------------------------------------------------------
  # WEB SERVER (Fixed Schema for Airflow 1.15.0)
  # ---------------------------------------------------------
  webserver:
    startupProbe:
      # We removed 'enabled' and 'initialDelaySeconds' to satisfy the schema
      # 60 failures * 10s period = 600 seconds (10 minutes) total time to start
      failureThreshold: 60  
      periodSeconds: 10
      timeoutSeconds: 20
    livenessProbe:
      # Removing initialDelaySeconds here as well for safety
      periodSeconds: 30
      timeoutSeconds: 20
      failureThreshold: 5
    readinessProbe:
      periodSeconds: 30
      timeoutSeconds: 20
      failureThreshold: 5
    resources:
      requests:
        cpu: "100m"
        memory: "512Mi"
    podAnnotations:
      gke-gcsfuse/volumes: "true"
    extraVolumes:
      - name: gcs-dags
        csi:
          driver: gcsfuse.csi.storage.gke.io
          volumeAttributes:
            bucketName: "dag-bucket213"
    extraVolumeMounts:
      - name: gcs-dags
        mountPath: /opt/airflow/dags
    extraContainers:
      - name: cloud-sql-proxy
        image: gcr.io/cloud-sql-connectors/cloud-sql-proxy:2.11.0
        args: ["--port=5432", "gcp-another-pro:us-east4:vamsi"]
    waitForMigrations:
      enabled: false
    service:
      type: LoadBalancer
      annotations:
        networking.gke.io/load-balancer-type: "Internal"
      ports:
        - name: airflow-ui
          port: 8080

  # ---------------------------------------------------------
  # SCHEDULER (Verified Working)
  # ---------------------------------------------------------
  scheduler:
    resources:
      requests:
        cpu: "100m"
        memory: "512Mi"
    podAnnotations:
      gke-gcsfuse/volumes: "true"
    extraVolumes:
      - name: gcs-dags
        csi:
          driver: gcsfuse.csi.storage.gke.io
          volumeAttributes:
            bucketName: "dag-bucket213"
    extraVolumeMounts:
      - name: gcs-dags
        mountPath: /opt/airflow/dags
    extraContainers:
      - name: cloud-sql-proxy
        image: gcr.io/cloud-sql-connectors/cloud-sql-proxy:2.11.0
        args: ["--port=5432", "gcp-another-pro:us-east4:vamsi"]
    waitForMigrations:
      enabled: false

  # ---------------------------------------------------------
  # TRIGGERER
  # ---------------------------------------------------------
  triggerer:
    waitForMigrations:
      enabled: false  # ADD THIS LINE
    resources:
      requests:
        cpu: "50m"
        memory: "256Mi"
    extraContainers:
      - name: cloud-sql-proxy
        image: gcr.io/cloud-sql-connectors/cloud-sql-proxy:2.11.0
        args: ["--port=5432", "gcp-another-pro:us-east4:vamsi"]

  statsd:
    resources:
      requests:
        cpu: "50m"
        memory: "128Mi"

  # ---------------------------------------------------------
  # WORKERS
  # ---------------------------------------------------------
  workers:
    resources:
      requests:
        cpu: "100m"
        memory: "512Mi"
    podAnnotations:
      gke-gcsfuse/volumes: "true"
    extraVolumes:
      - name: gcs-dags
        csi:
          driver: gcsfuse.csi.storage.gke.io
          volumeAttributes:
            bucketName: "dag-bucket213"
    extraVolumeMounts:
      - name: gcs-dags
        mountPath: /opt/airflow/dags

  # ---------------------------------------------------------
  # JOBS
  # ---------------------------------------------------------
  migrateDatabaseJob:
    useHelmHooks: false
    extraContainers:
      - name: cloud-sql-proxy
        image: gcr.io/cloud-sql-connectors/cloud-sql-proxy:2.11.0
        args: ["--port=5432", "gcp-another-pro:us-east4:vamsi"]

  createUserJob:
    useHelmHooks: false
    extraContainers:
      - name: cloud-sql-proxy
        image: gcr.io/cloud-sql-connectors/cloud-sql-proxy:2.11.0
        args: ["--port=5432", "gcp-another-pro:us-east4:vamsi"]

  # 5. DAG Storage
  dags:
    gitSync:
      enabled: false
    persistence:
      enabled: false

  # 6. Workload Identity & RBAC
  rbac:
    create: true
  serviceAccount:
    create: true
    annotations:
      iam.gke.io/gcp-service-account: "airflow-gsa@gcp-another-pro.iam.gserviceaccount.com"

  # 7. LOG STORAGE
  logs:
    persistence:
      enabled: false 
  config:
    core:
      load_examples: "False"
      dags_folder: "/opt/airflow/dags"
