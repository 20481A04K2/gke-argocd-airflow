airflow:
  # 1. Disable internal DB/Redis
  postgresql:
    enabled: false
  redis:
    enabled: false

  # 2. Database Connection (Using the secret from External Secrets)
  data:
    metadataSecretName: "airflow-db-secrets"

  # 3. Component Configs
  executor: "KubernetesExecutor"
  
  images:
    airflow:
      repository: "apache/airflow"
      tag: "2.10.0"

  # ---------------------------------------------------------
  # DAGs via GitSync (Public Repo)
  # ---------------------------------------------------------
  dags:
    persistence:
      enabled: false # We use gitSync instead of a PersistentVolume
    gitSync:
      enabled: true
      repo: "https://github.com/20481A04K2/gke-argocd-airflow.git"
      branch: "main"
      subPath: "bucket"  # The folder inside your repo where DAGs live
      wait: 60           # Sync every 60 seconds

  # ---------------------------------------------------------
  # WEB SERVER
  # ---------------------------------------------------------
  webserver:
    startupProbe:
      failureThreshold: 60  
      periodSeconds: 10
      timeoutSeconds: 20
    livenessProbe:
      periodSeconds: 30
      timeoutSeconds: 20
      failureThreshold: 5
    readinessProbe:
      periodSeconds: 30
      timeoutSeconds: 20
      failureThreshold: 5
    resources:
      requests:
        cpu: "100m"
        memory: "512Mi"
    # Note: GCS annotations, volumes, and mounts are REMOVED
    extraContainers:
      - name: cloud-sql-proxy
        image: gcr.io/cloud-sql-connectors/cloud-sql-proxy:2.11.0
        args: ["--port=5432", "gcp-another-pro:asia-southeast1:vamsi"]
    waitForMigrations:
      enabled: false
    service:
      type: LoadBalancer
      annotations:
        networking.gke.io/load-balancer-type: "Internal"
      ports:
        - name: airflow-ui
          port: 8080

  # ---------------------------------------------------------
  # SCHEDULER
  # ---------------------------------------------------------
  scheduler:
    resources:
      requests:
        cpu: "100m"
        memory: "512Mi"
    # Note: GCS annotations, volumes, and mounts are REMOVED
    extraContainers:
      - name: cloud-sql-proxy
        image: gcr.io/cloud-sql-connectors/cloud-sql-proxy:2.11.0
        args: ["--port=5432", "gcp-another-pro:asia-southeast1:vamsi"]
    waitForMigrations:
      enabled: false

  # ---------------------------------------------------------
  # TRIGGERER
  # ---------------------------------------------------------
  triggerer:
    waitForMigrations:
      enabled: false
    resources:
      requests:
        cpu: "50m"
        memory: "256Mi"
    extraContainers:
      - name: cloud-sql-proxy
        image: gcr.io/cloud-sql-connectors/cloud-sql-proxy:2.11.0
        args: ["--port=5432", "gcp-another-pro:asia-southeast1:vamsi"]

  statsd:
    resources:
      requests:
        cpu: "50m"
        memory: "128Mi"

  # ---------------------------------------------------------
  # WORKERS
  # ---------------------------------------------------------
  workers:
    resources:
      requests:
        cpu: "100m"
        memory: "512Mi"

  # ---------------------------------------------------------
  # JOBS
  # ---------------------------------------------------------
  migrateDatabaseJob:
    useHelmHooks: false
    extraContainers:
      - name: cloud-sql-proxy
        image: gcr.io/cloud-sql-connectors/cloud-sql-proxy:2.11.0
        args: ["--port=5432", "gcp-another-pro:asia-southeast1:vamsi"]

  createUserJob:
    useHelmHooks: false
    extraContainers:
      - name: cloud-sql-proxy
        image: gcr.io/cloud-sql-connectors/cloud-sql-proxy:2.11.0
        args: ["--port=5432", "gcp-another-pro:asia-southeast1:vamsi"]

  # 6. Workload Identity & RBAC (Required for Cloud SQL Proxy)
  rbac:
    create: true
  serviceAccount:
    create: true
    annotations:
      iam.gke.io/gcp-service-account: "airflow-gsa@gcp-another-pro.iam.gserviceaccount.com"

  # 7. LOG STORAGE
  logs:
    persistence:
      enabled: false 

  config:
    core:
      load_examples: "False"
      # dags_folder is managed automatically by GitSync
